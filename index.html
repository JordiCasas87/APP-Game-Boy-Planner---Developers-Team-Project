<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Planner Boy</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:'Press Start 2P', monospace;}
  
  body {
    margin: 0;
    /* --- NUEVO FONDO --- */
    /* Usamos la imagen proporcionada como fondo, centrada y cubriendo todo */
    background: url('image_0.png') no-repeat center center fixed;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
    
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    
    /* --- AJUSTE DE MÁRGENES SUPERIORES --- */
    /* Aumentamos el padding superior para evitar la barra de URL.
       Usamos 'max()' y 'env(safe-area-inset-top)' para respetar el 'notch' en móviles modernos */
    padding: max(40px, env(safe-area-inset-top) + 20px) 16px max(16px, env(safe-area-inset-bottom)) 16px;
  }

  /* DMG-like proportions */
  .console{
    width:min(390px, 96vw);
    aspect-ratio: 3/5;
    background:#c4c4c4;
    border-radius:26px;
    padding:14px 14px 12px 14px;
    display:flex;
    flex-direction:column;
    box-shadow: 0 10px 30px rgba(0,0,0,.45);
  }

  .top{
    display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    color:#444;font-size:8px;user-select:none;
    padding:2px 2px 6px 2px;
  }
  .brand{letter-spacing:1px;line-height:1.4}
  .hint{opacity:.85;line-height:1.4;text-align:right;max-width:55%}

  .screen-container{
    background:#555;
    padding:12px;
    border-radius:14px;
    margin-top:6px;
  }
  .screen{
    background:#9bbc0f;
    border:6px solid #0f380f;
    height:36%;
    min-height:230px;
    color:#0f380f;
    padding:10px;
    overflow:hidden;
    border-radius:8px;
  }
  .screen *{color:#0f380f}
  .line{margin:6px 0;font-size:10px;line-height:1.6}
  .tiny{font-size:8px;line-height:1.5;opacity:.95}
  .title{margin:4px 0 10px 0;font-size:11px}
  .divider{height:2px;background:#0f380f;margin:8px 0;opacity:.35}
  .selectable{cursor:pointer}
  .selected{background:rgba(15,56,15,.18);padding:2px 4px;border-radius:6px}

  .controls{
    margin-top:auto;
    display:flex;
    justify-content:space-between;
    gap:14px;
    padding:10px 0 2px 0;
  }
  .dpad{
    display:grid;
    grid-template-columns:44px 44px 44px;
    grid-template-rows:44px 44px 44px;
    gap:6px;
  }
  .dpad button{
    background:#444;border:none;border-radius:10px;color:#fff;
    font-size:14px;cursor:pointer;touch-action:manipulation;
    box-shadow: inset 0 -2px 0 rgba(0,0,0,.35);
  }
  .dpad button:active,.btns button:active,.menu-btns button:active{transform:translateY(1px)}
  .btns{display:flex;flex-direction:column;justify-content:center;gap:14px}
  .btns button{
    width:58px;height:58px;border-radius:50%;
    background:#7c0a0a;border:none;color:#fff;font-size:14px;cursor:pointer;touch-action:manipulation;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,.35);
  }
  .menu-btns{
    display:flex;justify-content:center;gap:18px;
    padding:10px 0 2px 0;
  }
  .menu-btns button{
    background:#777;border:none;padding:10px 14px;border-radius:10px;
    font-size:8px;cursor:pointer;touch-action:manipulation;
    box-shadow: inset 0 -2px 0 rgba(0,0,0,.25);
  }

  /* Form inside screen */
  .form{display:flex;flex-direction:column;gap:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:8px;opacity:.9}
  input, select, textarea{
    width:100%;
    font-size:10px;
    padding:8px 8px;
    border:3px solid #0f380f;
    border-radius:10px;
    background:rgba(255,255,255,.35);
    outline:none;
  }
  textarea{min-height:74px;resize:none}
  .form-help{font-size:8px;line-height:1.5;opacity:.9}
  .row{display:flex;gap:10px}
  .row .field{flex:1}

  @media (max-height: 700px){
    .screen{min-height:210px}
    .dpad{grid-template-columns:40px 40px 40px;grid-template-rows:40px 40px 40px}
    .btns button{width:54px;height:54px}
  }
</style>
</head>
<body>
  <div class="console">
    <div class="top">
      <div class="brand">PLANNER BOY<br><span class="tiny">developers Team</span></div>
      <div class="hint" id="hint"></div>
    </div>

    <div class="screen-container">
      <div class="screen" id="screen"></div>
    </div>

    <div class="controls">
      <div class="dpad">
        <div></div><button id="up" aria-label="Up">▲</button><div></div>
        <button id="left" aria-label="Left">◄</button><div></div><button id="right" aria-label="Right">►</button>
        <div></div><button id="down" aria-label="Down">▼</button><div></div>
      </div>

      <div class="btns">
        <button id="btnA" aria-label="A">A</button>
        <button id="btnB" aria-label="B">B</button>
      </div>
    </div>

    <div class="menu-btns">
      <button id="startBtn">START</button>
      <button id="selectBtn">SELECT</button>
    </div>
  </div>

<script>
/** ========= Storage ========= */
const Storage = {
  load(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      const val = JSON.parse(raw);
      return (val ?? fallback);
    }catch(e){ return fallback; }
  },
  save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

// Use Planner Boy keys (separate from previous builds)
const Keys = { events:"plannerboy.events", notes:"plannerboy.notes", tasks:"plannerboy.tasks" };

let events = Storage.load(Keys.events, []);
let notes  = Storage.load(Keys.notes, []);
let tasks  = Storage.load(Keys.tasks, []);

function uid(){
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now();
}

/** ========= Validators ========= */
function requireNonEmpty(value, field){
  if(!String(value ?? "").trim()) throw new Error(field + " is required");
}
function validateEvent(e){ requireNonEmpty(e.title, "Title"); requireNonEmpty(e.date, "Date"); }
function validateNote(n){ requireNonEmpty(n.title, "Title"); }
function validateTask(t){
  requireNonEmpty(t.title, "Title");
  if(!t.priority) t.priority = "MEDIUM";
  if(!t.done) t.done = "NO";
}

/** ========= UI State Machine ========= */
const screen = document.getElementById("screen");
const hint = document.getElementById("hint");

// Menu order requested: TASKS first
const MainMenu = ["TASKS", "EVENTS", "NOTES", "ABOUT"];
let state = { name:"cover" };

function setHint(text){ hint.textContent = text || ""; }

/** ========= Render Helpers ========= */
function line(text, cls="line"){ return `<div class="${cls}">${text}</div>`; }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

/** ========= Formatting ========= */
function formatEventRow(e){
  const when = (e.date ? e.date : "----") + (e.time ? (" " + e.time) : "");
  return `${when}  ${e.title}`;
}
function formatTaskRow(t){
  const mark = (t.done === "YES") ? "[x]" : "[ ]";
  return `${mark} ${t.title} (${t.priority})`;
}
function formatNoteRow(n){ return `${n.title}`; }

function listData(section){
  if(section==="EVENTS") return { key: Keys.events, arr: events, format: formatEventRow };
  if(section==="NOTES")  return { key: Keys.notes,  arr: notes,  format: formatNoteRow  };
  return { key: Keys.tasks, arr: tasks, format: formatTaskRow };
}
function persist(section){
  const {key, arr} = listData(section);
  Storage.save(key, arr);
}

/** ========= Screens ========= */
function renderCover(){
  setHint("START: menu");
  const d = new Date();
  screen.innerHTML = `
    ${line("PLANNER BOY","title")}
    ${line("developers Team","tiny")}
    <div class="divider"></div>
    ${line(d.toDateString(),"line")}
    <div class="divider"></div>
    ${line("PRESS START","line")}
    ${line("Tip: ▲▼ + A/B · SELECT new","tiny")}
  `;
}

function renderMainMenu(){
  setHint("▲▼ move · A select · B cover");
  const idx = state.index ?? 0;
  const html = MainMenu.map((item,i)=>{
    const sel = i===idx ? 'selected' : '';
    const prefix = i===idx ? '&gt; ' : '&nbsp;&nbsp;';
    return `<div class="line selectable ${sel}" data-i="${i}">${prefix}${item}</div>`;
  }).join("");
  screen.innerHTML = `
    ${line("MAIN MENU","title")}
    <div class="divider"></div>
    ${html}
    <div class="divider"></div>
    ${line("SELECT: quick add task","tiny")}
  `;
  wireSelectableLines();
}

function renderList(section){
  setHint("▲▼ move · A open · SELECT new · B back");
  const {arr, format} = listData(section);
  const idx = Math.min(state.index ?? 0, Math.max(0, arr.length-1));
  state.index = idx;

  const rows = (arr.length ? arr : [{_empty:true}]).map((item,i)=>{
    if(item._empty){
      return `<div class="line">-- EMPTY --</div>`;
    }
    const sel = (i===idx) ? "selected" : "";
    const prefix = (i===idx) ? "&gt; " : "&nbsp;&nbsp;";
    return `<div class="line selectable ${sel}" data-i="${i}">${prefix}${escapeHtml(format(item))}</div>`;
  }).join("");

  screen.innerHTML = `
    ${line(section,"title")}
    <div class="divider"></div>
    ${rows}
    <div class="divider"></div>
    ${line("A: open · SELECT: new","tiny")}
  `;
  wireSelectableLines();
}

function renderDetail(section, item){
  setHint("A edit · SELECT delete · B back");
  let body = "";
  if(section==="EVENTS"){
    body = `
      ${line(escapeHtml(item.title),"title")}
      ${line(`DATE: ${escapeHtml(item.date || "")}`,"line")}
      ${line(`TIME: ${escapeHtml(item.time || "-")}`,"line")}
      <div class="divider"></div>
      ${line(escapeHtml(item.description || ""), "tiny")}
    `;
  } else if(section==="NOTES"){
    body = `
      ${line(escapeHtml(item.title),"title")}
      <div class="divider"></div>
      ${line(escapeHtml(item.content || ""), "tiny")}
    `;
  } else { // TASKS
    body = `
      ${line(escapeHtml(item.title),"title")}
      ${line(`PRIORITY: ${escapeHtml(item.priority || "MEDIUM")}`,"line")}
      ${line(`DONE: ${escapeHtml(item.done || "NO")}`,"line")}
      <div class="divider"></div>
      ${line(escapeHtml(item.description || ""), "tiny")}
      <div class="divider"></div>
      ${line("Tip: Usar Cruceta ◄/► para marcar DONE","tiny")}
    `;
  }
  screen.innerHTML = body;
}

function renderForm(section, mode, item){
  setHint("A save · B cancel");
  const isEdit = mode === "edit";
  const t = (section==="EVENTS") ? (isEdit ? "EDIT EVENT" : "NEW EVENT")
          : (section==="NOTES")  ? (isEdit ? "EDIT NOTE" : "NEW NOTE")
          :                        (isEdit ? "EDIT TASK" : "NEW TASK");

  const ev = section==="EVENTS";
  const no = section==="NOTES";
  const ta = section==="TASKS";

  const model = JSON.parse(JSON.stringify(item || {}));
  if(ev){
    model.title = model.title ?? "";
    model.description = model.description ?? "";
    model.date = model.date ?? new Date().toISOString().slice(0,10);
    model.time = model.time ?? "";
  }
  if(no){
    model.title = model.title ?? "";
    model.content = model.content ?? "";
  }
  if(ta){
    model.title = model.title ?? "";
    model.description = model.description ?? "";
    model.priority = model.priority ?? "MEDIUM";
    model.done = model.done ?? "NO";
  }

  screen.innerHTML = `
    ${line(t,"title")}
    <div class="divider"></div>
    <div class="form" id="form">
      <div class="field">
        <label>Title</label>
        <input id="fTitle" value="${escapeAttr(model.title)}" />
      </div>

      ${ev ? `
        <div class="row">
          <div class="field">
            <label>Date</label>
            <input id="fDate" type="date" value="${escapeAttr(model.date)}" />
          </div>
          <div class="field">
            <label>Time</label>
            <input id="fTime" type="time" value="${escapeAttr(model.time)}" />
          </div>
        </div>
        <div class="field">
          <label>Description</label>
          <textarea id="fDesc">${escapeHtml(model.description)}</textarea>
        </div>
      ` : ""}

      ${no ? `
        <div class="field">
          <label>Content</label>
          <textarea id="fContent">${escapeHtml(model.content)}</textarea>
        </div>
      ` : ""}

      ${ta ? `
        <div class="row">
          <div class="field">
            <label>Priority</label>
            <select id="fPriority">
              ${["LOW","MEDIUM","HIGH"].map(p => `<option value="${p}" ${model.priority===p?"selected":""}>${p}</option>`).join("")}
            </select>
          </div>
          <div class="field">
            <label>Done</label>
            <select id="fDone">
              ${["NO","YES"].map(d => `<option value="${d}" ${model.done===d?"selected":""}>${d}</option>`).join("")}
            </select>
          </div>
        </div>
        <div class="field">
          <label>Description</label>
          <textarea id="fDesc">${escapeHtml(model.description)}</textarea>
        </div>
      ` : ""}

      <div class="form-help">Puedes escribir normal (incluye espacios). A=Guardar · B=Cancelar.</div>
      <div class="divider"></div>
      ${line("Teclado: Enter=A · Esc=B · Space=SELECT (si no estás escribiendo)","tiny")}
    </div>
  `;

  // Focus title on desktop for convenience
  setTimeout(()=>{ document.getElementById("fTitle")?.focus(); }, 30);
}

function renderAbout(){
  setHint("B back");
  screen.innerHTML = `
    ${line("ABOUT","title")}
    <div class="divider"></div>
    ${line("PLANNER BOY v1","line")}
    ${line("Retro planner for 3 devs.","tiny")}
    <div class="divider"></div>
    ${line("Saved in LocalStorage","tiny")}
    ${line("No server needed","tiny")}
  `;
}

function renderConfirmDelete(section, item){
  setHint("A confirm · B cancel");
  const summary = section==="TASKS" ? formatTaskRow(item) : section==="EVENTS" ? formatEventRow(item) : formatNoteRow(item);
  screen.innerHTML = `
    ${line("DELETE?","title")}
    <div class="divider"></div>
    ${line(escapeHtml(summary),"tiny")}
    <div class="divider"></div>
    ${line("A: delete · B: cancel","tiny")}
  `;
}

function renderError(msg){
  setHint("B back");
  screen.innerHTML = `
    ${line("ERROR","title")}
    <div class="divider"></div>
    ${line(escapeHtml(msg),"line")}
    <div class="divider"></div>
    ${line("Press B to return","tiny")}
  `;
}

function render(){
  switch(state.name){
    case "cover": return renderCover();
    case "mainMenu": return renderMainMenu();
    case "list": return renderList(state.section);
    case "detail": return renderDetail(state.section, state.item);
    case "form": return renderForm(state.section, state.mode, state.item);
    case "about": return renderAbout();
    case "confirmDelete": return renderConfirmDelete(state.section, state.item);
    case "error": return renderError(state.message || "Unknown error");
    default: return renderCover();
  }
}

/** ========= Navigation & CRUD ========= */
function goCover(){ state = {name:"cover"}; render(); }
function goMainMenu(){ state = {name:"mainMenu", index:0}; render(); }

function deleteItem(section, index){
  const {arr} = listData(section);
  if(index < 0 || index >= arr.length) return;
  arr.splice(index,1);
  persist(section);
  state = {name:"list", section, index:Math.max(0, index-1)};
  render();
}
function toggleTaskDone(index){
  const item = tasks[index];
  if(!item) return;
  item.done = (item.done === "YES") ? "NO" : "YES";
  Storage.save(Keys.tasks, tasks);
}

/** ========= Form collect/save ========= */
function collectForm(){
  const section = state.section;
  if(section==="EVENTS"){
    return {
      title: document.getElementById("fTitle")?.value ?? "",
      date: document.getElementById("fDate")?.value ?? "",
      time: document.getElementById("fTime")?.value ?? "",
      description: document.getElementById("fDesc")?.value ?? ""
    };
  }
  if(section==="NOTES"){
    return {
      title: document.getElementById("fTitle")?.value ?? "",
      content: document.getElementById("fContent")?.value ?? ""
    };
  }
  return {
    title: document.getElementById("fTitle")?.value ?? "",
    priority: document.getElementById("fPriority")?.value ?? "MEDIUM",
    done: document.getElementById("fDone")?.value ?? "NO",
    description: document.getElementById("fDesc")?.value ?? ""
  };
}

function saveForm(){
  const section = state.section;
  const payload = collectForm();

  try{
    if(section==="EVENTS") validateEvent(payload);
    if(section==="NOTES") validateNote(payload);
    if(section==="TASKS") validateTask(payload);
  }catch(err){
    state = {name:"error", message: String(err.message || err)};
    render();
    return;
  }

  if(section==="EVENTS"){
    if(state.mode==="new"){
      events.unshift({ id: uid(), ...payload });
    }else{
      events[state.index] = { ...events[state.index], ...payload };
    }
    Storage.save(Keys.events, events);
  }else if(section==="NOTES"){
    if(state.mode==="new"){
      notes.unshift({ id: uid(), ...payload });
    }else{
      notes[state.index] = { ...notes[state.index], ...payload };
    }
    Storage.save(Keys.notes, notes);
  }else{
    if(state.mode==="new"){
      tasks.unshift({ id: uid(), ...payload });
    }else{
      tasks[state.index] = { ...tasks[state.index], ...payload };
    }
    Storage.save(Keys.tasks, tasks);
  }

  state = {name:"list", section, index:0};
  render();
}

/** ========= Click selection ========= */
function wireSelectableLines(){
  screen.querySelectorAll(".selectable").forEach(el=>{
    el.addEventListener("click", ()=>{
      const i = Number(el.dataset.i);
      if(Number.isNaN(i)) return;
      if(state.name === "mainMenu"){ state.index = i; render(); }
      else if(state.name === "list"){ state.index = i; render(); }
    });
    el.addEventListener("dblclick", ()=>{
      if(state.name === "mainMenu" || state.name === "list") onA();
    });
  });
}

/** ========= Controls ========= */
function onUp(){
  if(state.name==="mainMenu"){
    state.index = (state.index - 1 + MainMenu.length) % MainMenu.length;
    render();
  }else if(state.name==="list"){
    const {arr} = listData(state.section);
    if(arr.length===0) return;
    state.index = (state.index - 1 + arr.length) % arr.length;
    render();
  }
}
function onDown(){
  if(state.name==="mainMenu"){
    state.index = (state.index + 1) % MainMenu.length;
    render();
  }else if(state.name==="list"){
    const {arr} = listData(state.section);
    if(arr.length===0) return;
    state.index = (state.index + 1) % arr.length;
    render();
  }
}
function onLeft(){
  if(state.name==="detail" && state.section==="TASKS"){
    toggleTaskDone(state.index);
    state.item = tasks[state.index];
    render();
  }
}
function onRight(){ onLeft(); }

function onA(){
  if(state.name==="cover"){ goMainMenu(); return; }

  if(state.name==="mainMenu"){
    const choice = MainMenu[state.index];
    if(choice==="ABOUT"){ state = {name:"about"}; render(); return; }
    state = {name:"list", section:choice, index:0};
    render();
    return;
  }

  if(state.name==="list"){
    const {arr} = listData(state.section);
    if(arr.length===0) return;
    state = {name:"detail", section:state.section, index:state.index, item: arr[state.index]};
    render();
    return;
  }

  if(state.name==="detail"){
    state = {name:"form", section:state.section, mode:"edit", item: state.item, index: state.index};
    render();
    return;
  }

  if(state.name==="form"){ saveForm(); return; }

  if(state.name==="about"){ goMainMenu(); return; }

  if(state.name==="confirmDelete"){
    deleteItem(state.section, state.index);
    return;
  }

  if(state.name==="error"){ goMainMenu(); return; }
}

function onB(){
  if(state.name==="cover") return;

  if(state.name==="mainMenu"){ goCover(); return; }

  if(state.name==="list"){ goMainMenu(); return; }

  if(state.name==="detail"){ state = {name:"list", section:state.section, index:state.index}; render(); return; }

  if(state.name==="form"){ state = {name:"list", section:state.section, index:0}; render(); return; }

  if(state.name==="about"){ goMainMenu(); return; }

  if(state.name==="confirmDelete"){
    state = {name:"detail", section:state.section, index:state.index, item: state.item};
    render();
    return;
  }

  if(state.name==="error"){ goMainMenu(); return; }
}

function onStart(){ goMainMenu(); }

function onSelect(){
  if(state.name==="mainMenu"){
    // Quick add task
    state = {name:"form", section:"TASKS", mode:"new", item:null, index:0};
    render();
    return;
  }
  if(state.name==="list"){
    state = {name:"form", section:state.section, mode:"new", item:null, index:0};
    render();
    return;
  }
  if(state.name==="detail"){
    state = {name:"confirmDelete", section:state.section, index:state.index, item: state.item};
    render();
    return;
  }
}

/** ========= Keyboard support (FIXED: don't hijack typing) ========= */
function isTyping(){
  const el = document.activeElement;
  if(!el) return false;
  const tag = (el.tagName || "").toUpperCase();
  return tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT" || el.isContentEditable === true;
}

document.addEventListener("keydown", (e)=>{
  // If user is typing in a field, don't steal keys (especially SPACE)
  if(isTyping()){
    if(e.key === "Escape"){
      e.preventDefault();
      onB();
    }
    return;
  }

  const k = e.key.toLowerCase();
  if(k==="arrowup") { e.preventDefault(); onUp(); }
  if(k==="arrowdown") { e.preventDefault(); onDown(); }
  if(k==="arrowleft") { e.preventDefault(); onLeft(); }
  if(k==="arrowright") { e.preventDefault(); onRight(); }
  if(k==="enter") { e.preventDefault(); onA(); }
  if(k==="escape" || k==="backspace") { e.preventDefault(); onB(); }
  if(k===" "){ e.preventDefault(); onSelect(); }  // SELECT only when not typing
  if(k==="s"){ e.preventDefault(); onStart(); }   // Start via "s"
});

/** ========= Wire buttons ========= */
document.getElementById("up").onclick = onUp;
document.getElementById("down").onclick = onDown;
document.getElementById("left").onclick = onLeft;
document.getElementById("right").onclick = onRight;
document.getElementById("btnA").onclick = onA;
document.getElementById("btnB").onclick = onB;
document.getElementById("startBtn").onclick = onStart;
document.getElementById("selectBtn").onclick = onSelect;

/** ========= Boot ========= */
state = {name:"cover"};
render();
</script>
</body>
</html>
